# Production values for laravel_backend_helm
# Overrides for prod environment

replicaCount: 3
podAnnotations:
  # reloader.stakater.com/rollout-strategy: "restart"
  secret.reloader.stakater.com/auto: "true"
  configmap.reloader.stakater.com/auto: "true"

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Image tags for prod (override if needed)
# imageBackend:
#   tag: "1.0.0"

# imageNginx:
#   tag: "1.24-alpine"

ingress:
  enabled: false
  className: traefik-external
  annotations: {}
  hosts: []
  tls: []

ingressRoute:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: traefik-external
  entryPoints:
    - websecure
  hosts:
    - host: prod-api.majedtec.com
      path: /
  tls:
    enabled: true
    secretName: tamweel-aloula-tls

migration:
  enabled: true

# Queue worker for prod
queue:
  enabled: true
  replicas: 2
  terminationGracePeriodSeconds: 60
  # envFrom is auto-generated from Secrets (when secret.enabled: true)
  # Uncomment to use secrets for sensitive data:
  # - secretRef:
  #     name: laravel-backend-env-prod
  # ConfigMap references are auto-generated from ConfigMaps (when config.enabled: true)
  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# Container resources for prod
containers:
  - name: backend
    imagePullPolicy: IfNotPresent
    command: ["php-fpm"]
    args: ["-F", "-R"]
    ports:
      - name: php-fpm
        containerPort: 9000
        protocol: TCP
    envFrom:
      # Uncomment to use secrets for sensitive data:
      # - secretRef:
      #     name: laravel-backend-env-prod
    # ConfigMap references are auto-generated from ConfigMaps (when config.enabled: true)
    startupProbe:
      exec:
        command:
          - /usr/local/bin/db-healthcheck.sh
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 30
    livenessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "500m"
  - name: nginx
    imagePullPolicy: IfNotPresent
    ports:
      - name: http
        containerPort: 80
        protocol: TCP
    readinessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "100m"
    volumeMounts:
      - name: nginx-config
        mountPath: /etc/nginx/conf.d/default.conf
        subPath: default.conf

# Redis for prod
redis:
  enabled: true
  replicas: 1

# ConfigMaps for prod
config:
  enabled: true
  data:
    - name: nginx-config
      config:
        default.conf: |
          server {
            listen 80;
            server_name localhost;

            root /var/www/public;
            index index.php index.html index.htm;

            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;

            # Laravel PHP handling
            location ~ \.php$ {
              include fastcgi_params;
              fastcgi_pass 127.0.0.1:9000;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;

              # Forward important headers for Laravel + Sanctum
              fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
              fastcgi_param HTTP_X_FORWARDED_HOST $host;
              fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
            }

            # SPA / Laravel routing
            location / {
              try_files $uri $uri/ /index.php?$query_string;
            }

            # Optional gzip
            gzip on;
            gzip_static on;
            gzip_types text/css application/javascript application/json image/svg+xml text/plain;
          }

# Secret - Disabled in favor of ExternalSecret
secret:
  enabled: false

# External Secret (Oracle Vault) for Prod
externalSecret:
  enabled: true
  refreshInterval: "1m"
  secretStoreRef:
    kind: ClusterSecretStore
    name: oci-prod-secret-store # Assumed
  target:
    name: oracle-prod-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: laravel_backend_prod

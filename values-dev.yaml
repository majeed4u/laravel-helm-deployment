# Development values for laravel_backend_helm
# Overrides for dev environment

replicaCount: 1

podAnnotations:
  # reloader.stakater.com/rollout-strategy: "restart"
  secret.reloader.stakater.com/auto: "true"
  configmap.reloader.stakater.com/auto: "true"
# Image pull secrets
imagePullSecrets:
  - name: docker

autoscaling:
  enabled: false

# Image tags for dev
imageNginx:
  tag: "alpine"
ingress:
  enabled: false
  # Legacy Ingress configuration - using IngressRoute instead
  className: traefik-external
  annotations: {}
  hosts: []
  tls: []

ingressRoute:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: traefik-external
  entryPoints:
    - web
    - websecure
  hosts:
    - host: dev-api.internalk.majedtec.com
      path: /
  tls:
    enabled: false

service:
  type: ClusterIP
  port: 80

migration:
  enabled: true

# Queue worker for dev
queue:
  enabled: true

  replicas: 2
  terminationGracePeriodSeconds: 30
  env: {}
  command:
    - "php"
    - "artisan"
    - "queue:work"
    - "--tries=3"
    - "--backoff=10"
    - "--max-jobs=1000"
    - "-v"
  # envFrom is auto-generated from Secrets (when secret.enabled: true)
  # Disable startup probe - queue worker starts fine, healthcheck has intl extension issue
  startupProbe:
    exec:
      command:
        - sh
        - -c
        - pgrep -f "artisan queue:work" > /dev/null
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Container resources for dev
containers:
  - name: backend
    # envFrom is auto-generated from Secrets (when secret.enabled: true)

    imagePullPolicy: IfNotPresent
    command: ["php-fpm"]
    args: ["-F", "-R"]
    ports:
      - name: php-fpm
        containerPort: 9000
        protocol: TCP
    startupProbe:
      exec:
        command:
          - /usr/local/bin/db-healthcheck.sh
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 30
    livenessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "200m"

  - name: nginx
    imagePullPolicy: IfNotPresent
    ports:
      - name: http
        containerPort: 80
        protocol: TCP
    readinessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "64Mi"
        cpu: "50m"
    volumeMounts:
      - name: nginx-config
        mountPath: /etc/nginx/conf.d/default.conf
        subPath: default.conf

# Redis for dev
redis:
  enabled: true
  replicas: 1

# Secret for environment variables
secret:
  enabled: false
  # data: ... (moved to vault)

# External Secret (Oracle Vault)
externalSecret:
  enabled: true
  refreshInterval: "1m"
  secretStoreRef:
    kind: ClusterSecretStore
    name: oci-dev-secret-store
  target:
    name: oracle-dev-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: laravel_backend_dev

# Secret Store (Oracle Vault)
secretStore:
  create: true
  name: oci-dev-secret-store
  kind: ClusterSecretStore
  provider:
    oracle:
      vault: ocid1.vault.oc1.me-jeddah-1.fvuqwwffaabee.abvgkljrm4sxfgjuecsro6ku7wf7h5dox4atvnvlvlwyw4kjv5o6lcna54cq
      region: me-jeddah-1
      user: ocid1.user.oc1..aaaaaaaaofeauzq7ayq4ajjhghdtebpo26duv2goiv4flsvu5rlb4rf6wuca
      tenancy: ocid1.tenancy.oc1..aaaaaaaalafgels7udlsaoqpl6k3ofr3mwtkfluzkgm4tjpe354dmkfxqwxa

# ConfigMaps for dev (only nginx config, no env vars - those are in Secret)
config:
  enabled: true
  data:
    - name: nginx-config
      config:
        default.conf: |
          server {
            listen 80;
            server_name localhost;

            root /var/www/public;
            index index.php index.html index.htm;

            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;

            # Laravel PHP handling
            location ~ \.php$ {
              include fastcgi_params;
              fastcgi_pass 127.0.0.1:9000;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;

              # Forward important headers for Laravel + Sanctum
              fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
              fastcgi_param HTTP_X_FORWARDED_HOST $host;
              fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
            }

            # SPA / Laravel routing
            location / {
              try_files $uri $uri/ /index.php?$query_string;
            }

            # Optional gzip
            gzip on;
            gzip_static on;
            gzip_types text/css application/javascript application/json image/svg+xml text/plain;
          }

# middleware:
#   headers:
#     enabled: false

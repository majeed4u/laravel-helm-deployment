# Default values for laravel_backend_helm.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# This will set the replicaset count more information can be found here: https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/
replicaCount: 1

# Image configurations for containers
imageBackend:
  repository: gitea.mjdev.dev/gitadmin/registery/laravel-backend
  tag: "32"

imageNginx:
  repository: docker.io/library/nginx
  tag: "alpine"

migration:
  enabled: false

# Queue worker configuration
queue:
  enabled: false # Set to true to enable queue worker deployment
  replicas: 2
  imagePullPolicy: IfNotPresent
  terminationGracePeriodSeconds: 60
  command:
    - "php"
    - "artisan"
    - "queue:work"
    - "--tries=3"
    - "--backoff=10"
    - "--max-jobs=1000"
    - "--quiet"
  envFrom:
    # Uncomment to use secrets for sensitive data:
    # - secretRef:
    #     name: laravel-backend-env
    # Example: Add multiple envFrom sources
    # - secretRef:
    #     name: laravel-backend-env
    # - secretRef:
    #     name: laravel-backend-secrets
    # - configMapRef:
    #     name: laravel-backend-config
  startupProbe:
    exec:
      command:
        - /usr/local/bin/db-healthcheck.sh
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 5
    failureThreshold: 30
  livenessProbe:
    exec:
      command:
        - pgrep
        - -f
        - "artisan queue:work"
    initialDelaySeconds: 20
    periodSeconds: 60
  readinessProbe:
    exec:
      command:
        - pgrep
        - -f
        - "artisan queue:work"
    initialDelaySeconds: 10
    periodSeconds: 30
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  volumes: []
  # - name: aiven-ca-cert
  #   secret:
  #     secretName: aiven-ca-cert

# List of containers to run in the pod
containers:
  - name: backend
    imagePullPolicy: IfNotPresent
    command: ["php-fpm"]
    args: ["-F", "-R"]
    ports:
      - name: php-fpm
        containerPort: 9000
        protocol: TCP
    envFrom:
      # Uncomment to use secrets for sensitive data:
      # - secretRef:
      #     name: laravel-backend-env
      # Example: Add multiple envFrom sources
      # - secretRef:
      #     name: laravel-backend-env
      # - secretRef:
      #     name: laravel-backend-secrets
      # - configMapRef:
      #     name: laravel-backend-config
    startupProbe:
      exec:
        command:
          - /usr/local/bin/db-healthcheck.sh
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 30
    livenessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      tcpSocket:
        port: 9000
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    # Resources defined per environment
  - name: nginx
    imagePullPolicy: IfNotPresent
    ports:
      - name: http
        containerPort: 80
        protocol: TCP
    readinessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    # Resources defined per environment

# This is for the secrets for pulling an image from a private repository more information can be found here: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
imagePullSecrets: []
# This is to override the chart name.
nameOverride: ""
fullnameOverride: ""

# This section builds out the service account more information can be found here: https://kubernetes.io/docs/concepts/security/service-accounts/
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# This is for setting Kubernetes Annotations to a Pod.
# For more information checkout: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/
podAnnotations: {}
# This is for setting Kubernetes Labels to a Pod.
# For more information checkout: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/
podLabels: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

# This is for setting up a service more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/
service:
  # This sets the service type more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types
  type: ClusterIP
  # This sets the ports more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/#field-spec-ports
  port: 80

# This block is for setting up the ingress for more information can be found here: https://kubernetes.io/docs/concepts/services-networking/ingress/
ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: chart-example.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# This section is for setting up autoscaling more information can be found here: https://kubernetes.io/docs/concepts/workloads/autoscaling/
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

# Nginx sidecar configuration
nginx:
  enabled: true # Set to true to enable nginx sidecar
  image: nginx:alpine
  config: |
    server {
            listen 80;
            server_name localhost;

            root /var/www/public;
            index index.php index.html index.htm;

            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;

            # Laravel PHP handling
            location ~ \.php$ {
                include fastcgi_params;
                fastcgi_pass 127.0.0.1:9000;
                fastcgi_index index.php;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PATH_INFO $fastcgi_path_info;

                # Forward important headers for Laravel + Sanctum
                fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
                fastcgi_param HTTP_X_FORWARDED_HOST $host;
                fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
            }

            # SPA / Laravel routing
            location / {
                try_files $uri $uri/ /index.php?$query_string;
            }

            # Optional gzip
            gzip on;
            gzip_static on;
            gzip_types text/css application/javascript application/json image/svg+xml text/plain;
        }

# General ConfigMaps configuration
config:
  enabled: false # Set to true to enable general ConfigMaps
  data: []
  # Example:
  # - name: nginx-config
  #   content:
  #     default.conf: |
  #       server {
  #           listen 80;
  #           server_name localhost;
  #           root /var/www/html/public;
  #       }
  # - name: app-config
  #   content:
  #     app.env: |
  #       APP_ENV=production
  #       APP_DEBUG=false

nodeSelector: {}

tolerations: []

affinity: {}

# Redis configuration
redis:
  enabled: false # Set to true to enable Redis deployment
  replicas: 1
  port: 6379
  image:
    repository: docker.io/library/redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 6379
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"
  livenessProbe:
    tcpSocket:
      port: 6379
    initialDelaySeconds: 5
    periodSeconds: 10
  readinessProbe:
    tcpSocket:
      port: 6379
    initialDelaySeconds: 5
    periodSeconds: 10

# Secret configuration for environment variables
secret:
  enabled: false
  data: []
  # Example:
  # - name: laravel-backend-env
  #   data:
  #     APP_ENV: "production"
  #     APP_DEBUG: "false"
  #     APP_KEY: "base64:..."
  #     DB_CONNECTION: "mysql"
  #     DB_HOST: "mysql-service"
  #     DB_PORT: "3306"
  #     DB_DATABASE: "laravel"
  #     DB_USERNAME: "laravel"
  #     DB_PASSWORD: "password"
  #     REDIS_HOST: "redis"
  #     REDIS_PORT: "6379"
  #     CACHE_DRIVER: "redis"
  #     SESSION_DRIVER: "redis"
  #     QUEUE_CONNECTION: "redis"

# Middleware configuration
middleware:
  headers:
    enabled: true

# IngressRoute configuration (Traefik CRD)
ingressRoute:
  enabled: false
  entryPoints:
    - web
    - websecure
  annotations: {}
  hosts:
    - host: chart-example.local
      path: /
  tls:
    enabled: false
    secretName: ""

# External Secret Configuration (Oracle Vault)
externalSecret:
  enabled: false
  refreshInterval: "1h"
  secretStoreRef:
    kind: ClusterSecretStore
    name: oci-dev-secret-store
  target:
    name: oracle-dev-secret
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: laravel_backend_dev

# Secret Store Configuration
secretStore:
  create: false
  name: oci-secret-store
  kind: ClusterSecretStore
  provider:
    oracle:
      vault: ""
      region: ""
      user: ""
      tenancy: ""
